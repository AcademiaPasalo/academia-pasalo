# PROYECTO: ACADEMIA PÁSALO - SISTEMA DE AUDITORÍA PROFESIONAL
========================================================================

## 1. CONTEXTO Y PROPÓSITO
El sistema de auditoría tiene como objetivo garantizar la trazabilidad total de acciones críticas de seguridad y negocio. Es un sistema HÍBRIDO que unifica datos de dos fuentes distintas para ofrecer una vista única al administrador sin comprometer el rendimiento de la base de datos.

## 2. ESTADO ACTUAL (FASE CORE COMPLETADA)
Se ha implementado el motor de auditoría con las siguientes características:
- **Tablas involucradas:** `security_event` (Seguridad/Red) y `audit_log` (Operaciones/Archivos).
- **Optimización RAM:** Caché de IDs de acciones en `AuditService` para evitar latencia de disco.
- **Seguridad:** Paginación forzada en backend (máx 100 registros) para prevenir desbordamiento de memoria (OOM).
- **Integridad:** Registro transaccional (ACID) vinculado a la operación principal.
- **Estatus de Pruebas:** 100% de éxito en Unit Tests y E2E (IAM, Security, Materials y Audit).

## 3. ESPECIFICACIONES TÉCNICAS (PARA EL SIGUIENTE AGENTE)
- **Módulo:** `src/modules/audit`
- **Servicio Principal:** `AuditService` (Contiene la lógica de unificación).
- **Endpoint:** `GET /audit/history` (Protegido por RolesGuard: ADMIN/SUPER_ADMIN).
- **Regla de Oro:** NUNCA usar comentarios explicativos en el código. Logs siempre en JSON. Imports con alias `@modules/`, `@common/`, etc.

## 4. ROADMAP DE IMPLEMENTACIÓN (PASOS SIGUIENTES)

### PASO 1: EXPORTACIÓN A EXCEL (REPORTE ADMINISTRATIVO)
- **Objetivo:** Permitir que el SuperAdmin descargue el historial filtrado.
- **Donde:** `AuditController` -> `GET /audit/export`.
- **Como:** 
  1. Instalar `exceljs`.
  2. Reutilizar `AuditService.getUnifiedHistory` para obtener la data filtrada.
  3. Transformar el JSON resultante a un Buffer de Excel.
  4. Retornar como `Stream` con headers `Content-Type: application/vnd.openxmlformats-officedocument.spreadsheetml.sheet`.

### PASO 2: CONTROL DE VISIBILIDAD GRANULAR (RBAC)
- **Objetivo:** El SuperAdmin controla qué puede ver el Admin.
- **Contexto:** Actualmente el Admin ve todo lo que ve el SuperAdmin.
- **Implementación:**
  1. Modificar `AuditService.getUnifiedHistory` para recibir el `currentUserRole`.
  2. Si es 'ADMIN', aplicar filtros adicionales (ej. no ver acciones de otros Admins o solo ver acciones de alumnos).
  3. Consultar `system_setting` con la clave `AUDIT_ADMIN_VISIBILITY_LEVEL` para decidir el rigor del filtro.

### PASO 3: DEPURACIÓN AUTOMÁTICA MENSUAL (CLEANUP CRON)
- **Objetivo:** Mantener la base de datos ligera y optimizada.
- **Frecuencia:** CADA MES (1 vez al mes).
- **Donde:** Nuevo servicio `src/modules/audit/application/audit-cleanup.service.ts`.
- **Como:**
  1. Usar `@nestjs/schedule` (instalar si no existe).
  2. Implementar `@Cron(CronExpression.EVERY_1ST_DAY_OF_MONTH_AT_MIDNIGHT)`.
  3. Lógica: Borrar registros de `security_event` y `audit_log` cuya antigüedad sea mayor a X meses (configurarlo en `system_setting`).
  4. **Importante:** Registrar el hecho de la depuración en el propio log de auditoría antes de borrar.

## 5. LINEAMIENTOS DE CALIDAD
- **ACID:** Cualquier registro de auditoría de negocio DEBE usar el `manager` de la transacción madre para garantizar consistencia.
- **Performance:** Las consultas unificadas siempre deben llevar `LIMIT` y `OFFSET`.
- **Typing:** Prohibido el uso de `any`. Usar DTOs y Entidades estrictamente.