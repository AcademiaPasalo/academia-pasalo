PLAN DE DESARROLLO: MÓDULO DE MATERIALES (FILES & FOLDERS)
=========================================================

CONTEXTO ACTUAL
---------------
El sistema ya cuenta con un núcleo robusto de Matrículas (Enrollments) y Evaluaciones.
- La tabla `enrollment_evaluation` es la Única Fuente de Verdad (SSOT) para los accesos.
- Existe un `AccessEngine` que valida: `hasAccess(userId, evaluationId)`.

OBJETIVO DE ESTA FASE
---------------------
Implementar la gestión de archivos (PDFs, imágenes) y carpetas jerárquicas, asegurando que el acceso a estos recursos esté protegido por las reglas de negocio ya implementadas en Enrollments.

ESTRUCTURA DE DATOS (Relaciones Clave)
--------------------------------------
1. `material_folder`:
   - Tiene `evaluation_id` (FK directa).
   - Tiene `parent_folder_id` (Recursividad para subcarpetas).
   - IMPORTANTE: Aunque sea una subcarpeta profunda, SIEMPRE debe tener el `evaluation_id` poblado. Esto evita tener que hacer recursividad ascendente para verificar permisos.

2. `material`:
   - Representa el "ítem" en la carpeta (ej. "Silabo del Curso").
   - Apunta a `file_version` actual.

3. `file_resource`:
   - Representa el archivo físico (blob, hash, size, mime-type). Inmutable.

4. `file_version`:
   - Historial de cambios. Si el profesor sube un nuevo sílabo, se crea un nuevo `file_resource` y una nueva `file_version`, pero el `material` mantiene su ID.

ESTRATEGIA DE SEGURIDAD (INTEGRACIÓN)
-------------------------------------
Para permitir ver una carpeta o descargar un archivo:

1. NO crear lógica nueva de permisos en `MaterialsService`.
2. REUTILIZAR `AccessEngineService`.
   - Al pedir una carpeta: Obtener su `evaluation_id`.
   - Llamar `await accessEngine.hasAccess(userId, folder.evaluationId)`.
   - Si devuelve `true`, entregar el contenido. Si `false`, lanzar 403.

REGLAS DE ELIMINACIÓN Y ARCHIVADO (CRÍTICO)
-------------------------------------------
El sistema NO permite borrado directo por parte de profesores. Se sigue un flujo estricto de aprobación:

1. Solicitud (Profesor):
   - El profesor NO puede eliminar `Material` ni `MaterialFolder`.
   - Debe crear un registro en la tabla `deletion_request`.
   - Estado inicial: `PENDING`.

2. Aprobación/Rechazo (Admin):
   - El Admin revisa las solicitudes pendientes.
   - Si APRUEBA: 
     - El estado del `Material` o `MaterialFolder` cambia a `ARCHIVED`.
     - El estado de la solicitud pasa a `APPROVED`.
     - El ítem deja de ser visible para alumnos.
   - Si RECHAZA:
     - El estado de la solicitud pasa a `REJECTED`.
     - El material sigue activo (`ACTIVE`).

3. Eliminación Física (Hard Delete):
   - Solo un ADMIN/SUPER_ADMIN puede eliminar definitivamente un registro.
   - Condición: El ítem debe estar previamente en estado `ARCHIVED`.

REGLAS DE IMPLEMENTACIÓN (HARD RULES)
-------------------------------------
1. Transaccionalidad (CRÍTICO):
   - La subida de un archivo implica insertar en: `file_resource` -> `file_version` -> `material`.
   - Todo debe estar envuelto en `dataSource.transaction`. Si falla la BD, se debe borrar el archivo físico (rollback manual del storage).

2. Almacenamiento:
   - Implementar `StorageService` en `infrastructure/storage`.
   - Usar almacenamiento local por ahora (`uploads/`), pero dejar la interfaz lista para S3 (`upload(file): Promise<string>`).

3. Validaciones:
   - Carpetas anidadas no pueden ser infinitas (validar ciclos si se mueve una carpeta, aunque por ahora solo es crear).
   - Validar mime-types permitidos en el DTO (PDF, JPG, PNG, DOCX).

PASOS SUGERIDOS
---------------
1. Implementar `StorageService` (Subida física).
2. Crear Entidades y Repositorios (`MaterialFolder`, `Material`, `FileResource`, `FileVersion`, `DeletionRequest`).
3. Implementar `MaterialFoldersService` (CRUD de carpetas).
4. Implementar `MaterialsService` (Subida, versionado y lógica de DeletionRequest).
5. Exponer Endpoints protegidos por `AccessEngine`.